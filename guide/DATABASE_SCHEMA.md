# Holy Family Academy - Database Schema Documentation

## Overview
This system uses **Firebase Firestore** (NoSQL) and **Firebase Storage** for data persistence.

Firebase Firestore does **NOT use traditional SQL schemas**. Instead, the database structure is defined through:
1. **Collections** - Container for documents (like tables in SQL)
2. **Documents** - Individual records with fields (like rows in SQL)
3. **Security Rules** - Access control and validation
4. **Application Code** - Data structure enforcement on server-side

---

## Firebase Project Configuration

**Location**: `firebase.json`

```json
{
  "firestore": {
    "database": "(default)",
    "location": "asia-southeast1"
  },
  "storage": {
    "rules": "storage.rules"
  },
  "database": {
    "rules": "database.rules.json"
  }
}
```

---

## Database Collections & Schema

**Total Collections: 14**

### Collections Summary Table

| # | Collection Name | Purpose | Location in Code |
|---|-----------------|---------|------------------|
| 1 | `users` | User authentication & profiles (admin/applicant) | `server/server.mjs` lines 205, 327, 555, 617, 642, 707, 743, 1019 |
| 2 | `jhsApplicants` | Junior High School student applications | `server/server.mjs` line 815 |
| 3 | `shsApplicants` | Senior High School student applications | `server/server.mjs` line 816 |
| 4 | `teacherApplicants` | Teacher job applications | `server/server.mjs` lines 854, 961, 1131; `routes/teacher-notifications.js` line 30 |
| 5 | `email_confirmations` | Email verification OTP codes for teachers | `server/server.mjs` lines 857, 935, 1137 |
| 6 | `applicant_messages` | Messages between admins and applicants | `server/dbClient.js` lines 39, 91; `server/server.mjs` line 1334 |
| 7 | `applicant_notifications` | Notifications for teacher applicants (deprecated - see teacherNotifications) | `utils/teacherDecision.js` line 58 |
| 8 | `teacherNotifications` | System notifications for teacher applicants | `utils/notificationService.js` line 106; `routes/teacher-notifications.js` lines 120, 164, 178, 193, 230 |
| 9 | `notifications` | System notifications for admins | `server/dbClient.js` line 71 |
| 10 | `activity_logs` | Admin action audit trail | `server/server.mjs` line 657 |
| 11 | `announcements` | School announcements and news posts | `routes/announcements.js` lines 117, 161, 223, 303 |
| 12 | `settings` | System settings (enrollment periods, etc.) | `routes/enrollment.js` lines 10, 61, 110, 140, 182 |
| 13 | `notes` | Admin personal quick notes | `routes/notes.js` lines 14, 68, 109, 160 |
| 14 | `admin_mail_sent` | Legacy admin mail system (DEPRECATED - not actively used) | `routes/admin-mail.js` |

---

### Detailed Collection Documentation

### 1. **users** Collection
**Purpose**: Store user authentication and profile data

**Document ID**: Firebase Auth UID

**Fields**:
```javascript
{
  uid: string,                    // Firebase Auth UID (same as document ID)
  email: string,                  // User's email address
  displayName: string,            // User's full name
  role: string,                   // "admin" or "applicant"
  forcePasswordChange: boolean,   // True if user must change password on next login
  createdAt: Timestamp,           // Account creation timestamp
  updatedAt: Timestamp            // Last update timestamp
}
```

**Used in**:
- `server/server.mjs` - Lines 205, 327, 555, 617, 642, 707, 743, 1019
- Authentication and authorization checks

---

### 2. **jhsApplicants** Collection
**Purpose**: Store Junior High School student applications

**Document ID**: Auto-generated by Firestore

**Fields**:
```javascript
{
  // Student Information
  studentFirstName: string,
  studentMiddleName: string,
  studentLastName: string,
  studentSuffix: string,
  age: number,
  sex: string,
  birthdate: string,

  
  // Contact Information
  email: string,
  contactEmail: string,
  contactNumber: string,
  address: string,
  
  // Academic Information
  gradeLevel: string,
  strand: string,
  
  // Requirements (document URLs from Firebase Storage)
  requirements: {
    reportcard: { url: string, checked: boolean },         // Form 138
    psa: { url: string, checked: boolean },                // Birth Certificate
    goodMoral: { url: string, checked: boolean }           // Good Moral Certificate
  },
  
  // Application Status
  status: string,                 // "pending", "approved", "rejected", "enrolled"
  notes: string,                  // Admin notes
  interviewSchedule: Timestamp,   // Interview date/time
  demoSchedule: Timestamp,        // Demonstration teaching date/time
  
  // Metadata
  formType: "jhs",
  createdAt: Timestamp,
  updatedAt: Timestamp
}
```

**Used in**: `server/server.mjs` - Line 815

---

### 3. **shsApplicants** Collection
**Purpose**: Store Senior High School student applications

**Document ID**: Auto-generated by Firestore

**Fields**: Same as `jhsApplicants` with additional fields:
```javascript
{
  // All fields from jhsApplicants, plus:
  
  // Additional SHS Requirements
  requirements: {
    reportcard: { url: string, checked: boolean },         // Form 138
    psa: { url: string, checked: boolean },                // Birth Certificate
    goodMoral: { url: string, checked: boolean },          // Good Moral Certificate
    form137: { url: string, checked: boolean },            // Form 137 (Permanent Record)
    completionCertificate: { url: string, checked: boolean },
    clearance: { url: string, checked: boolean }
  },
  
  formType: "shs"
}
```

**Used in**: `server/server.mjs` - Line 816

---

### 4. **teacherApplicants** Collection
**Purpose**: Store teacher job applications

**Document ID**: Auto-generated by Firestore

**Fields**:
```javascript
{
  // Personal Information
  firstName: string,
  middleName: string,
  lastName: string,
  suffix: string,
  displayName: string,            // Full name for display
  birthdate: string,
  age: number,
  sex: string,
  civilStatus: string,
  religion: string,
  
  // Contact Information
  email: string,                  // Primary email
  contactEmail: string,           // Alternative email
  phoneNumber: string,
  address: string,
  
  // Professional Information
  position: string,               // Position applied for
  specialization: string,
  yearsExperience: number,
  currentEmployer: string,
  
  // Education
  education: [
    {
      degree: string,
      school: string,
      yearGraduated: number
    }
  ],
  
  // Documents (URLs from Firebase Storage)
  resume: { url: string },
  certificates: [{ url: string, name: string }],
  validId: { url: string },
  
  // Application Status
  status: string,                 // "pending", "submitted", "approved", "rejected"
  notes: string,
  interviewSchedule: Timestamp,
  demoSchedule: Timestamp,
  
  // Authentication
  uid: string,                    // Firebase Auth UID (after account creation)
  
  // Metadata
  formType: "teacher",
  createdAt: Timestamp,
  updatedAt: Timestamp,
  deletedAt: Timestamp,           // Soft delete for expired accounts
  isExpired: boolean              // Auto-deleted after 30 days if not approved
}
```

**Used in**:
- `server/server.mjs` - Lines 854, 961, 1131
- `server/dbClient.js` - Lines 174, 198

---

### 5. **email_confirmations** Collection
**Purpose**: Store email verification OTP codes for teacher applicants

**Document ID**: applicationId (matches teacherApplicants document ID)

**Fields**:
```javascript
{
  email: string,                  // Email to verify
  otp: string,                    // 6-digit verification code
  expiresAt: number,              // Expiration timestamp (5 minutes)
  lastSentAt: number,             // Last OTP send time (cooldown check)
  resendCount: number,            // Number of resend attempts
  firstResendAt: number,          // First resend timestamp (rate limiting window)
  createdAt: Timestamp
}
```

**Used in**: `server/server.mjs` - Lines 857, 935, 1137

---

### 6. **applicant_messages** Collection
**Purpose**: Store messages between admins and teacher applicants

**Document ID**: Auto-generated by Firestore

**Fields**:
```javascript
{
  applicantId: string,            // References teacherApplicants document ID
  fromUid: string,                // Sender's Firebase Auth UID
  senderName: string,             // Sender's display name
  senderEmail: string,            // Sender's email
  subject: string,                // Message subject
  body: string,                   // Message content
  recipients: [string],           // Array of recipient UIDs
  
  // File Attachment (optional)
  attachment: {
    fileName: string,
    fileUrl: string,              // Firebase Storage download URL
    fileType: string,
    fileSize: number
  },
  
  // Status
  isArchived: boolean,            // Message archived status
  archivedAt: Timestamp,          // Archive timestamp
  
  createdAt: Timestamp
}
```

**Used in**:
- `server/dbClient.js` - Lines 39, 91
- `server/server.mjs` - Line 1334

**Composite Index Required**:
- Fields: `applicantId` (Ascending) + `createdAt` (Ascending)
- Used for: Fetching messages for a specific applicant ordered by time

---

### 7. **applicant_notifications** Collection
**Purpose**: Store notifications for teacher applicants (Note: Being replaced by teacherNotifications)

**Document ID**: Auto-generated by Firestore

**Fields**:
```javascript
{
  applicantId: string,            // References teacherApplicants document ID
  applicantEmail: string,         // Applicant's email
  title: string,                  // Notification title
  message: string,                // Notification content
  type: string,                   // "status_update", "new_message", etc.
  read: boolean,                  // Read status
  readAt: Timestamp,              // When notification was read
  createdAt: Timestamp
}
```

**Used in**: `server/utils/teacherDecision.js` - Line 58

---

### 8. **teacherNotifications** Collection
**Purpose**: System notifications for teacher applicants (replaces applicant_notifications)

**Document ID**: Auto-generated by Firestore

**Fields**:
```javascript
{
  applicantId: string,            // References teacherApplicants document ID
  applicantEmail: string,         // Applicant's email
  type: string,                   // "progress_update", "interview_scheduled", "status_change", etc.
  title: string,                  // Notification title
  message: string,                // Notification content
  step: string,                   // Progress step if applicable
  read: boolean,                  // Read status (default: false)
  readAt: Timestamp,              // When notification was read
  createdAt: Timestamp
}
```

**Used in**:
- `server/utils/notificationService.js` - Line 106
- `server/routes/teacher-notifications.js` - Lines 120, 164, 178, 193, 230

---

### 9. **notifications** Collection
**Purpose**: Store system notifications for admins

**Document ID**: Auto-generated by Firestore

**Fields**:
```javascript
{
  type: string,                   // "applicant_message", "new_application", etc.
  applicantId: string,            // Related applicant ID
  messageId: string,              // Related message ID (if applicable)
  seenBy: [string],               // Array of UIDs who have seen this notification
  createdAt: Timestamp
}
```

**Used in**: `server/dbClient.js` - Line 71

---

### 10. **activity_logs** Collection
**Purpose**: Store admin activity audit logs

**Document ID**: Auto-generated by Firestore

**Fields**:
```javascript
{
  actorUid: string,               // Admin who performed action
  actorEmail: string,             // Admin's email
  actorName: string,              // Admin's display name
  targetUid: string,              // Target user affected (optional)
  action: string,                 // Action type (see list below)
  detail: string,                 // Additional details (JSON string)
  timestamp: Timestamp,
  createdAt: Timestamp
}
```

**Logged Actions**:
- `admin-send-message` - Message sent to applicant
- `applicant-created` - New teacher account created
- `send-admin-otp` - OTP sent for admin verification
- `create-admin` - New admin account created
- `update-user` - User profile updated
- `archive-user` - User archived
- `unarchive-user` - User restored from archive
- `delete-user` - User permanently deleted
- `reset-password` - Password reset link generated
- `approve-application` - Application approved
- `reject-application` - Application rejected
- **`update-enrollment-settings`** - Enrollment dates updated ✨ NEW
- **`start-enrollment`** - Enrollment opened (JHS/SHS) ✨ NEW
- **`close-enrollment`** - Enrollment closed (JHS/SHS) ✨ NEW
- `bulk-sync-teacher-names` - Teacher names synced
- `clear-force-password` - Password change flag cleared

**Used in**: 
- `server/server.mjs` - Line 657
- `server/routes/enrollment.js` - Lines 113, 174, 235
- `server/routes/admin-users.js`
- `server/routes/admin-actions.js`

---

### 11. **announcements** Collection
**Purpose**: Store school announcements and news posts (with image upload support)

**Document ID**: Auto-generated by Firestore

**Fields**:
```javascript
{
  type: string,                   // "announcement" or "news"
  title: string,                  // Post title
  body: string,                   // Post content/body
  category: string,               // "ACADEMIC", "GENERAL", "EVENT", "SPORTS"
  imageUrl: string,               // Optional image from Firebase Storage (optimized to 1920px, 80% quality)
  archived: boolean,              // Archived status (soft delete)
  archivedAt: Timestamp,          // Archive timestamp
  createdAt: Timestamp,           // Post creation time
  createdBy: string,              // Admin UID who created post
  createdByName: string,          // Admin display name
  updatedAt: Timestamp,           // Last update time
  updatedBy: string               // Admin UID who last updated
}
```

**Used in**: `server/routes/announcements.js` - Lines 117, 161, 223, 303

**Features**:
- Image upload with automatic optimization (Sharp library)
- Archive/restore functionality (soft delete)
- Public GET endpoint for landing page
- Admin-only POST/PUT/DELETE endpoints

---

### 12. **settings** Collection
**Purpose**: Store system-wide settings (enrollment periods, configurations)

**Document ID**: Custom ID (e.g., "enrollment")

**Sub-document Structure** (for enrollment settings):
```javascript
{
  jhs: {
    startDate: string,            // "YYYY-MM-DD" format
    endDate: string,              // "YYYY-MM-DD" format
    isOpen: boolean               // Manual override for enrollment status
  },
  shs: {
    startDate: string,            // "YYYY-MM-DD" format
    endDate: string,              // "YYYY-MM-DD" format
    isOpen: boolean               // Manual override for enrollment status
  },
  updatedAt: string,              // ISO timestamp
  updatedBy: string               // Admin email who last updated
}
```

**Used in**: `server/routes/enrollment.js` - Lines 10, 61, 110, 140, 182

**Features**:
- Date-based enrollment status calculation
- Manual open/close control via isOpen flag
- Separate settings for JHS and SHS
- Public GET endpoint for status checks
- Admin-only PUT endpoints for updates

---

### 13. **notes** Collection
**Purpose**: Admin personal quick notes (similar to sticky notes)

**Document ID**: Auto-generated by Firestore

**Fields**:
```javascript
{
  userId: string,                 // Admin UID who owns this note
  text: string,                   // Note content (max 500 characters)
  createdAt: Timestamp,           // Note creation time
  updatedAt: Timestamp            // Last update time (null if never updated)
}
```

**Used in**: `server/routes/notes.js` - Lines 14, 68, 109, 160

**Features**:
- User-specific notes (filtered by userId)
- Character limit: 500 characters
- CRUD operations: GET, POST, PUT, DELETE
- Admin-only access via requireAdmin middleware
- Ownership check: users can only edit/delete their own notes

**Composite Index Required**:
- Fields: `userId` (Ascending) + `createdAt` (Descending)
- Used for: Fetching user's notes sorted by newest first

---

### 14. **admin_mail_sent** Collection  
**Purpose**: Legacy admin mail system (DEPRECATED - No longer actively used)

**Status**: ⚠️ **DEPRECATED** - Replaced by `applicant_messages` collection

**Document ID**: Auto-generated by Firestore

**Previous Fields**:
```javascript
{
  from: string,                   // Sender admin email
  to: string,                     // Recipient email
  subject: string,                // Email subject
  body: string,                   // Email body
  sentAt: Timestamp,              // Send timestamp
  sentBy: string                  // Admin UID
}
```

**Used in**: `server/routes/admin-mail.js` (deprecated endpoint)

**Note**: System now uses `/api/teacher-applicants/:id/send-message` endpoint which saves to `applicant_messages` collection instead. This collection may be removed in future cleanup.

---

## Firebase Storage Structure

**Purpose**: Store uploaded files (documents, images, attachments)

### Storage Buckets:

1. **`/requirements/{applicantId}/{fileName}`**
   - Student application requirements (Form 138, PSA, Good Moral, etc.)
   - Files uploaded during JHS/SHS application

2. **`/teacher-documents/{applicantId}/{fileName}`**
   - Teacher application documents (resume, certificates, valid ID)

3. **`/message-attachments/{messageId}/{fileName}`**
   - File attachments sent in messages

4. **`/announcements/{announcementId}/{fileName}`**
   - Announcement images and media

---

## How Data is Saved in Firebase

### 1. **Client-Side Upload (Student/Teacher Application)**

```javascript
// Frontend uploads file to Firebase Storage
const fileRef = storage.ref(`/requirements/${applicantId}/reportcard.pdf`);
await fileRef.put(file);
const downloadUrl = await fileRef.getDownloadURL();

// Send application data with file URL to server
fetch('/api/submit-application', {
  method: 'POST',
  body: JSON.stringify({
    ...formData,
    requirements: {
      reportcard: { url: downloadUrl, checked: false }
    }
  })
});
```

### 2. **Server-Side Save to Firestore**

```javascript
// server/server.mjs - Line 835
const docRef = await db.collection(collectionName).add(toSave);
const newId = docRef.id;  // Auto-generated document ID
```

### 3. **Data Flow Diagram**

```
User fills form → Frontend validation → Upload files to Storage
                                              ↓
                                    Get file download URLs
                                              ↓
                                    Send to backend API
                                              ↓
                                    Server validates data
                                              ↓
                                Save to Firestore collection
                                              ↓
                                    Return document ID
                                              ↓
                                    Show success message
```

---

## Security Rules

**Location**: `database.rules.json`

```json
{
  "rules": {
    ".read": false,    // No direct Firebase read access
    ".write": false    // No direct Firebase write access
  }
}
```

**All database operations go through the backend server** which:
1. Validates user authentication (Firebase Auth tokens)
2. Checks user roles (admin vs applicant)
3. Validates data structure
4. Enforces business rules
5. Logs admin actions

This ensures:
- ✅ Centralized access control
- ✅ Data validation
- ✅ Security enforcement
- ✅ Audit trail

---

## Required Firestore Indexes

Firebase Firestore requires composite indexes for queries that combine multiple fields or use inequality operators with orderBy. Here are all required indexes:

### Composite Indexes

| Collection | Fields | Order | Purpose |
|------------|--------|-------|---------|
| `applicant_messages` | `applicantId` + `createdAt` | ASC + ASC | Fetch messages for applicant in chronological order |
| `applicant_messages` | `isArchived` + `archivedAt` | ASC + ASC | Find old archived messages for cleanup |
| `teacherApplicants` | `status` + `createdAt` | ASC + ASC | Find expired pending applications for auto-deletion |
| `teacherApplicants` | `uid` | ASC | Lookup applicant by Firebase Auth UID (single field, auto-created) |
| `teacherNotifications` | `applicantId` + `createdAt` | ASC + DESC | Fetch notifications for applicant sorted by newest first |
| `teacherNotifications` | `applicantId` + `read` | ASC + ASC | Count unread notifications for applicant |
| `notes` | `userId` + `createdAt` | ASC + DESC | Fetch user's notes sorted by newest first |
| `announcements` | `archived` + `createdAt` | ASC + DESC | Fetch active/archived posts sorted by date |
| `announcements` | `type` + `createdAt` | ASC + DESC | Filter by announcement/news type with sorting |
| `announcements` | `category` + `createdAt` | ASC + DESC | Filter by category with sorting |
| `activity_logs` | `actorUid` + `createdAt` | ASC + DESC | Fetch admin's actions sorted by date |

### How to Create Indexes

**Option 1: Firebase Console**
1. Go to https://console.firebase.google.com
2. Select your project (HFA-School-Portal)
3. Navigate to Firestore Database → Indexes
4. Click "Create Index" and add the fields listed above

**Option 2: Error-Driven Creation**
- When a query requires an index, Firestore returns an error with a direct link
- Click the link to auto-generate the index
- Example error: "The query requires an index. You can create it here: [URL]"

**Option 3: Firebase CLI (firestore.indexes.json)**
```json
{
  "indexes": [
    {
      "collectionGroup": "applicant_messages",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "applicantId", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "ASCENDING" }
      ]
    }
  ]
}
```

---

## Data Validation & Business Rules

### Server-Side Validation Examples:

**1. Email Confirmation (OTP)**
```javascript
// Rate limiting: Max 3 resends per hour
if (resendCount >= 3) {
  return res.status(429).json({ error: 'Resend limit reached' });
}

// Cooldown: 3 minutes between resends
if (now - lastSentAt < 180000) {
  return res.status(429).json({ error: 'Cooldown active' });
}
```

**2. Role-Based Access Control**
```javascript
// Only admins can access admin routes
const requireAdmin = async (req, res, next) => {
  const userDoc = await db.collection('users').doc(uid).get();
  if (userDoc.data().role !== 'admin') {
    return res.status(403).json({ error: 'Forbidden' });
  }
  next();
};
```

**3. Data Integrity**
```javascript
// Email must match application record
if (storedEmail !== providedEmail) {
  return res.status(403).json({ error: 'Email mismatch' });
}
```

---

## Automated Database Maintenance

### 1. **Teacher Account Auto-Deletion**
**Cron Job**: Daily at 2:00 AM

```javascript
// Delete teacher applicant accounts older than 30 days with status "pending"
const thirtyDaysAgo = new Date();
thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

const expiredApplicants = await db.collection('teacherApplicants')
  .where('status', '==', 'pending')
  .where('createdAt', '<', thirtyDaysAgo)
  .get();

// Soft delete: Mark as expired and remove from Auth
```

### 2. **Archived Messages Auto-Deletion**
**Cron Job**: Daily at 2:00 AM

```javascript
// Delete archived messages older than 60 days
const sixtyDaysAgo = new Date();
sixtyDaysAgo.setDate(sixtyDaysAgo.getDate() - 60);

const oldMessages = await db.collection('applicant_messages')
  .where('isArchived', '==', true)
  .where('archivedAt', '<', sixtyDaysAgo)
  .get();
```

---

## Summary for Defense Panel

### Why Firebase Firestore?

1. **Scalability**: NoSQL database scales horizontally automatically
2. **Real-time**: Supports real-time listeners for instant updates
3. **Security**: Server-side enforcement through backend API
4. **File Storage**: Integrated Firebase Storage for documents/images
5. **Authentication**: Built-in Firebase Auth integration
6. **Cost-Effective**: Pay-per-use pricing model
7. **Reliability**: 99.95% uptime SLA from Google

### Database Design Decisions:

1. **Separate Collections for Student Types**: jhsApplicants vs shsApplicants
   - Different requirements per level
   - Easier to query and manage

2. **Document References**: Using document IDs as references
   - `applicantId` in messages → links to `teacherApplicants/{id}`
   - `uid` in users → links to Firebase Auth

3. **Denormalization**: Storing display names in multiple places
   - Optimizes read performance (NoSQL best practice)
   - Reduces need for joins

4. **Soft Deletes**: Using `deletedAt` and `isExpired` flags
   - Maintains data integrity
   - Allows recovery if needed
   - Enables audit trail

5. **Server-Side Only Access**: All operations through backend API
   - Maximum security
   - Data validation
   - Business logic enforcement

---

---

## Database Statistics

**Total Collections**: 14 (1 deprecated)  
**Active Collections**: 13  
**Total Storage Buckets**: 4  
**Database Location**: Firebase Firestore (asia-southeast1)  
**Region**: Asia Southeast 1 (Singapore)  
**Project**: HFA-School-Portal  

**Last Updated**: October 24, 2025 at 3:05 AM  
**Last Analyzed**: Complete codebase scan of all backend routes
